name: Docker Nightly Build

on:
  schedule:
    - cron: '0 0 * * *' # Runs at midnight UTC every d
  workflow_dispatch:
  
jobs:
  docker-build-and-run:
    runs-on: ubuntu-latest
    strategy:
        matrix:
          branch: [angular-v6, angular-v7, angular-v8, angular-v8-nes, angular-v9, angular-v10, angular-v10-nes, angular-v11, angular-v11-nes, angular-v12, angular-v12-nes, angular-v13, angular-v13-nes, angular-v14, angular-v14-nes, angular-v15, angular-v15-nes, angular-v16, angular-v17.2] # Your Angular version branches
    steps:
    - uses: actions/checkout@v3
      with:
          ref: ${{ matrix.branch }}
    - name: Build the Docker image
      run: |
        TIMESTAMP=$(date +%s)
        docker build . --file Dockerfile --tag ${{ matrix.branch }}-$TIMESTAMP
    - name: Run Docker container
      run: |
        TIMESTAMP=$(date +%s) # Re-calculate timestamp for consistency in naming
        docker run -d -p 4200:4200 --name ${{ matrix.branch }}-$TIMESTAMP ${{ matrix.branch }}-$TIMESTAMP
        sleep 10 # Give some time for the application to start

    - name: Check Docker container logs
      run: |
        TIMESTAMP=$(date +%s) # Re-calculate timestamp to access the correct container logs
        docker logs ${{ matrix.branch }}-$TIMESTAMP

    - name: Check if Docker container is still running
      run: |
        TIMESTAMP=$(date +%s) # Re-calculate timestamp to check the correct container status
        if [ $(docker inspect -f {{.State.Running}} ${{ matrix.branch }}-$TIMESTAMP) = "false" ]; then
          echo "Container ${{ matrix.branch }}-$TIMESTAMP is not running as expected"
          exit 1
        fi
